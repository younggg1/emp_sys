<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.empsys.backend.mapper.EmploymentMapper">

    <!-- 根据学生ID获取就业记录 -->
    <select id="getRecordsByStudent" resultType="com.empsys.backend.entity.EmploymentRecord">
        SELECT * FROM employment_record
        WHERE student_id = #{studentId}
        ORDER BY create_time DESC
    </select>
    
    <!-- 根据辅导员ID获取就业记录 -->
    <select id="getRecordsByCounselor" resultType="com.empsys.backend.entity.EmploymentRecord">
        SELECT e.*
        FROM employment_record e
        JOIN student s ON e.student_id = s.student_id
        WHERE s.counselor_id = #{counselorId}
        <if test="year != null">
            AND YEAR(e.graduation_date) = #{year}
        </if>
        ORDER BY e.create_time DESC
    </select>
    
    <!-- 根据学校ID获取就业记录 -->
    <select id="getRecordsBySchool" resultType="com.empsys.backend.entity.EmploymentRecord">
        SELECT e.*
        FROM employment_record e
        JOIN student s ON e.student_id = s.student_id
        WHERE s.school_id = #{schoolId}
        <if test="year != null">
            AND YEAR(e.graduation_date) = #{year}
        </if>
        ORDER BY e.create_time DESC
    </select>
    
    <!-- 获取区域分布统计 -->
    <select id="getRegionDistribution" resultType="java.util.Map">
        SELECT e.region AS name, COUNT(*) AS value
        FROM employment_record e
        JOIN student s ON e.student_id = s.student_id
        <where>
            <if test="counselorId != null">
                s.counselor_id = #{counselorId}
            </if>
            <if test="schoolId != null">
                AND s.school_id = #{schoolId}
            </if>
            <if test="year != null">
                AND YEAR(e.graduation_date) = #{year}
            </if>
            AND e.status = 'approved'
        </where>
        GROUP BY e.region
        ORDER BY value DESC
    </select>
    
    <!-- 获取薪资分布统计 -->
    <select id="getSalaryDistribution" resultType="java.util.Map">
        <![CDATA[
    SELECT
        CASE
            WHEN e.salary < 5000 THEN '5000以下'
            WHEN e.salary >= 5000 AND e.salary < 8000 THEN '5000-8000'
            WHEN e.salary >= 8000 AND e.salary < 10000 THEN '8000-10000'
            WHEN e.salary >= 10000 AND e.salary < 15000 THEN '10000-15000'
            WHEN e.salary >= 15000 AND e.salary < 20000 THEN '15000-20000'
            ELSE '20000以上'
        END AS name,
        COUNT(*) AS value
    FROM employment_record e
    JOIN student s ON e.student_id = s.student_id
    ]]>
        <where>
            <if test="counselorId != null">
                s.counselor_id = #{counselorId}
            </if>
            <if test="schoolId != null">
                AND s.school_id = #{schoolId}
            </if>
            <if test="year != null">
                AND YEAR(e.graduation_date) = #{year}
            </if>
            AND e.status = 'approved'
        </where>
        GROUP BY name
        ORDER BY
        CASE name
        WHEN '5000以下' THEN 1
        WHEN '5000-8000' THEN 2
        WHEN '8000-10000' THEN 3
        WHEN '10000-15000' THEN 4
        WHEN '15000-20000' THEN 5
        WHEN '20000以上' THEN 6
        END
    </select>
    
    <!-- 获取公司性质分布统计 -->
    <select id="getCompanyNatureDistribution" resultType="java.util.Map">
        SELECT e.company_nature AS name, COUNT(*) AS value
        FROM employment_record e
        JOIN student s ON e.student_id = s.student_id
        <where>
            <if test="counselorId != null">
                s.counselor_id = #{counselorId}
            </if>
            <if test="schoolId != null">
                AND s.school_id = #{schoolId}
            </if>
            <if test="year != null">
                AND YEAR(e.graduation_date) = #{year}
            </if>
            AND e.status = 'approved'
        </where>
        GROUP BY e.company_nature
        ORDER BY value DESC
    </select>
    
    <!-- 获取就业趋势 -->
    <select id="getEmploymentTrend" resultType="java.util.Map">
        SELECT 
            YEAR(e.graduation_date) AS year,
            COUNT(*) AS total,
            COUNT(CASE WHEN e.status = 'approved' THEN 1 END) AS employed
        FROM employment_record e
        JOIN student s ON e.student_id = s.student_id
        <where>
            <if test="counselorId != null">
                s.counselor_id = #{counselorId}
            </if>
            <if test="schoolId != null">
                AND s.school_id = #{schoolId}
            </if>
            <if test="startYear != null and endYear != null">
                AND YEAR(e.graduation_date) BETWEEN #{startYear} AND #{endYear}
            </if>
        </where>
        GROUP BY YEAR(e.graduation_date)
        ORDER BY year ASC
    </select>
    
</mapper> 
